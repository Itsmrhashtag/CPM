<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Seller</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- For alerts -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.0/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">

<div class="container mx-auto mt-10">
    <h1 class="text-3xl font-bold text-center mb-8">Received Orders</h1>
    
    <!-- Orders Section -->
    <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Orders will be dynamically inserted here -->
    </div>
</div>

<script>
    // Function to fetch orders
    async function fetchOrders() {
        // Get the seller's email from local storage
        const user = JSON.parse(localStorage.getItem("user"));
        const sellerEmail = user.user.email;

        // If no seller email in local storage, redirect to login page
        if (!sellerEmail) {
            alert('You are not logged in. Please log in to view your orders.');
            window.location.href = '/login.html';  // Redirect to the login page
            return;
        }

        // Get the authentication token
        const token = user.token;  // Assuming you store the JWT token in localStorage

        // If no token is found, redirect to login page
        if (!token) {
            alert('You are not authenticated. Please log in.');
            window.location.href = '/login.html';  // Redirect to the login page
            return;
        }

        try {

            // Fetch the received orders from the backend API
            const res = await fetch(`http://localhost:8080/api/orders/received-orders?sellerEmail=${sellerEmail}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`  // Add the JWT token to the Authorization header
                }
            });

            if (!res.ok) {
                throw new Error('Failed to fetch orders');
            }

            const orders = await res.json();

            // Get the container where orders will be displayed
            const container = document.getElementById('orders-container');
            container.innerHTML = '';  // Clear any previous content

            if (orders.length === 0) {
                container.innerHTML = '<p class="text-center text-lg text-gray-600">No orders received yet.</p>';
                return;
            }

            // Create HTML for each order
            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6';

                const imageUrl = order.product.imageNames?.length
                    ? `/images/${order.product.imageNames[0]}`
                    : 'https://via.placeholder.com/150';

                card.innerHTML = `
                    <img src="${imageUrl}" alt="Product Image" class="w-full h-40 object-cover rounded-md mb-4">
                    <h2 class="text-xl font-semibold mb-2">${order.product.title}</h2>
                    <p class="text-gray-700 mb-2">${order.product.description}</p>
                    <p><strong>Buyer:</strong> ${order.buyer.name}</p>
                    <p><strong>Mechanic Requested:</strong> ${order.mechanicRequested ? 'Yes' : 'No'}</p>
                `;

                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error fetching orders:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Failed to load orders. Please try again later.'
            });
        }
    }

    // Run the function on page load to fetch orders
    window.onload = fetchOrders;
</script>

</body>
</html>
