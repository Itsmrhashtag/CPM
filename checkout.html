<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Car Part Marketplace</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .StripeElement {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #submit-button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #submit-button:disabled {
      background-color: #888;
    }
    select {
      padding: 8px;
      width: 100%;
      border-radius: 4px;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<h2>Checkout</h2>

<!-- Product Section -->
<div id="product-detail" class="section">
  <h3>ðŸ›’ Product Summary</h3>
  <!-- Product details will be populated here by JavaScript -->
</div>

<!-- Mechanic Selection -->
<div class="section">
  <h3>ðŸ§° Choose a Mechanic (Based on your Pincode)</h3>
  <label for="pincode">Enter Your Pincode:</label>
  <input type="text" id="pincode" placeholder="e.g. 560076" />
  <button onclick="fetchMechanics()">Find Mechanics</button>

  <div id="mechanic-dropdown" style="margin-top: 12px; display:none;">
    <label for="mechanicSelect">Select Mechanic:</label>
    <select id="mechanicSelect"></select>
  </div>
</div>

<!-- Payment Section -->
<div class="section">
  <h3>ðŸ’³ Payment</h3>
  <form id="payment-form">
    <div id="payment-element"><!--Stripe.js injects elements here--></div>
    <button id="submit-button">Pay â‚¹10.00</button>
  </form>
  <p id="order-status"></p>
</div>

<script>
  const stripe = Stripe("pk_test_51OSa1ASI94bxAiqNPhrns6JhCfkJwZf16TlX7iqylqmbCwUbYEThqtOzzdY5uRR8c1LSSk0CNSux0BXC8uEZsIO300Zf0OzWzp");
  let elements;

  const paymentForm = document.getElementById("payment-form");
  const submitButton = document.getElementById("submit-button");
  const orderStatus = document.getElementById("order-status");

  const userData = JSON.parse(localStorage.getItem('user'));
  const token = userData?.token;

  // Get product ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('productId');

  // Fetch product details from the API
  async function fetchProductDetails() {
    try {
        const response = await fetch(`http://localhost:8080/api/products/${productId}`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const product = await response.json();

        const productDetail = document.getElementById("product-detail");
        productDetail.innerHTML = `
          <p><strong>Item:</strong> ${product.title}</p>
          <p><strong>Price:</strong> â‚¹${product.price}</p>
          <p><strong>Quantity:</strong> 1</p>
          <p><strong>Total:</strong> â‚¹${product.price}</p>
        `;
        
        // Initialize Stripe for payment
        await initializePayment(product.price);
    } catch (error) {
        console.error("Error fetching product details:", error);
        document.getElementById("product-detail").innerHTML = `<p class="text-red-500">Failed to load product details: ${error.message}</p>`;
    }
  }

  // Initialize Stripe Payment
  async function initializePayment(amount) {
    const response = await fetch("http://localhost:8080/api/payment/create-payment-intent", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ amount: amount  })
    });

    const { clientSecret } = await response.json();
    elements = stripe.elements({ clientSecret });
    const paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");
  }

  // Handle payment submission
  async function handleSubmit(event) {
  event.preventDefault();
  submitButton.disabled = true;
  orderStatus.textContent = "Processing payment...";

  const { error, paymentIntent } = await stripe.confirmPayment({
    elements,
    confirmParams: {
      return_url: window.location.href
    },
    redirect: "if_required"
  });

  // Check if paymentIntent exists
  if (paymentIntent && paymentIntent.status === "succeeded") {
    orderStatus.textContent = "âœ… Payment successful!";
    await placeOrder(paymentIntent.id);
  } else if (error) {
    // If payment fails, but a paymentIntent exists, still show ID
    const failedId = error?.payment_intent?.id;
    console.error("Payment failed:", error.message);
    orderStatus.textContent = `âŒ Payment failed: ${error.message}`;

    if (failedId) {
      console.log("Failed PaymentIntent ID:", failedId);
      await placeOrder(failedId); // optional: still call placeOrder for test
    }
  } else {
    orderStatus.textContent = "âš ï¸ Payment was not successful.";
    submitButton.disabled = false;
  }
}



  // Place order after successful payment
  async function placeOrder(paymentIntentId) {
    const mechanicId = document.getElementById("mechanicSelect").value;
    const mechanicRequested = mechanicId !== "" && mechanicId !== undefined;

    try {
      const orderData = {
        productId: productId,
        mechanicRequested: mechanicRequested,
        mechanicId: mechanicRequested ? mechanicId : null,
        paymentIntentId: paymentIntentId
      };

      const queryParams = new URLSearchParams({
  productId: productId,
  mechanicRequested: mechanicRequested,
  paymentIntentId: paymentIntentId,
});

if (mechanicRequested && mechanicId) {
  queryParams.append("mechanicId", mechanicId);
}

const res = await fetch(`http://localhost:8080/api/orders/place?${queryParams.toString()}`, {
  method: "POST",
  headers: {
    "Authorization": `Bearer ${token}`
  }
});


const result = await res.text(); // âœ… use .text() instead of .json() since the response is a plain string

if (result === 'Order placed successfully') {
  orderStatus.textContent = "âœ… Order placed successfully!";
} else {
  orderStatus.textContent = "âŒ Failed to place order.";
}
} catch (error) {
console.error("Error placing the order:", error);
orderStatus.textContent = "âŒ Failed to place order.";
}
}

  paymentForm.addEventListener("submit", handleSubmit);

  // Fetch product details when the page loads
  fetchProductDetails();

  // Mechanic section logic
  async function fetchMechanics() {
    const pincode = document.getElementById("pincode").value;
    if (!pincode) return alert("Please enter a pincode.");

    try {
      const res = await fetch(`http://localhost:8080/api/orders/nearby-mechanics`, {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      const mechanics = await res.json();

      const dropdown = document.getElementById("mechanicSelect");
      dropdown.innerHTML = "";

      mechanics.forEach(m => {
        const option = document.createElement("option");
        option.value = m.userId;
        option.textContent = `${m.name} - ${m.experience} yrs experience`;
        dropdown.appendChild(option);
      });

      document.getElementById("mechanic-dropdown").style.display = "block";
    } catch (error) {
      alert("Error fetching mechanics. Please try again.");
      console.error(error);
    }
  }
</script>

</body>
</html>
