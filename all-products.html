<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products - CarPartMarketplace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .product-card {
            @apply bg-white rounded-lg shadow-md p-4 transition-transform transform hover:scale-105;
        }
        .product-card-title {
            @apply text-xl font-semibold text-gray-800 mb-2;
        }
        .product-card-description {
            @apply text-gray-700 mb-2;
        }
        .product-card-price {
            @apply text-gray-900 font-bold text-lg mb-2;
        }
        .product-card-image {
            @apply rounded-md mb-4 w-full h-48 object-cover;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded;
        }
        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        /* Swiper Styles */
        .swiper {
            width: 100%;
            height: 300px;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .swiper-slide {
            text-align: center;
            font-size: 18px;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .swiper-pagination-bullet-active {
            background-color: #3b82f6; /* Tailwind's blue-500 */
        }

        /* Search Bar Styles */
        .search-container {
            margin-bottom: 2rem;
        }
        .search-input {
            @apply w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
        .search-button {
            @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 ml-3;
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-gray-800 text-white py-4">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl font-semibold">All Products</h1>
        </div>
    </header>
    <main class="container mx-auto px-4 py-8">
        <div class="search-container flex items-center">
            <input
                type="text"
                id="search-input"
                placeholder="Search products..."
                class="search-input"
            />
            <button id="search-button" class="search-button">Search</button>
        </div>
        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-center">
                <p class="text-gray-500">Loading products...</p>
            </div>
        </div>
    </main>
    <script>
        const myHeaders = new Headers();
        const user = localStorage.getItem('user');
        let userId = null;
        if (user) {
            const authToken = JSON.parse(user).token;
            userId = JSON.parse(user).user.userId;
            myHeaders.append("Authorization", `Bearer ${authToken}`);
        } else {
            window.location.href = '/login.html';
        }

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch("http://localhost:8080/api/products/all", requestOptions)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Failed to fetch products');
                    });
                }
                return response.json();
            })
            .then(result => {
                const productList = document.getElementById('product-list');
                productList.innerHTML = '';
                const allProducts = result;

                // Filter out the user's own products
                const otherProducts = allProducts.filter(product => product.seller.userId !== userId);

                if (otherProducts && otherProducts.length > 0) {
                    displayProducts(otherProducts); // Initial display
                } else {
                    productList.innerHTML = '<div class="text-center col-span-full"><p class="text-gray-500">No other products found.</p></div>';
                }

                // Search functionality
                document.getElementById('search-button').addEventListener('click', () => {
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    const filteredProducts = otherProducts.filter(product =>
                        product.title.toLowerCase().includes(searchTerm) ||
                        product.description.toLowerCase().includes(searchTerm)
                    );
                    productList.innerHTML = '';
                    displayProducts(filteredProducts);
                });
            })
            .catch(error => {
                const productList = document.getElementById('product-list');
                productList.innerHTML = `<div class="text-center col-span-full text-red-500">${error.message}</div>`;
                console.error(error);
            });

        function displayProducts(products) {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            if (products && products.length > 0) {
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';

                    let imageContent = '';
                    if (product.imageNames && product.imageNames.length > 1) {
                        // Create carousel for multiple images
                        imageContent = `<div class="swiper">
                                        <div class="swiper-wrapper">`;
                        product.imageNames.forEach(imageName => {
                            imageContent += `<div class="swiper-slide">
                                                <img src="http://localhost:8080/uploads/${imageName}" alt="${product.title}" class="product-card-image">
                                            </div>`;
                        });
                        imageContent += `</div>
                                        <div class="swiper-pagination"></div>
                                    </div>`;
                    } else if (product.imageNames && product.imageNames.length === 1) {
                        // Display single image
                        imageContent = `<img src="http://localhost:8080/uploads/${product.imageNames[0]}" alt="${product.title}" class="product-card-image">`;
                    } else {
                        // Display placeholder
                        imageContent = `<img src="https://via.placeholder.com/150" alt="${product.title}" class="product-card-image">`;
                    }

                    productCard.innerHTML = `
                        ${imageContent}
                        <h2 class="product-card-title">${product.title}</h2>
                        <p class="product-card-description">${product.description}</p>
                        <p class="product-card-price">Price: $${product.price}</p>
                        <a href="/product-detail.html?id=${product.id}" class="btn-primary">View Details</a>
                    `;
                    productList.appendChild(productCard);

                    if (product.imageNames && product.imageNames.length > 1) {
                        // Initialize Swiper carousel
                        const swiper = new Swiper(productCard.querySelector('.swiper'), {
                            // Optional parameters
                            direction: 'horizontal',
                            loop: true,
                            // If we need pagination
                            pagination: {
                                el: '.swiper-pagination',
                            },
                            // Navigation arrows
                            // navigation: {
                            //     nextEl: '.swiper-button-next',
                            //     prevEl: '.swiper-button-prev',
                            // },
                            // And if we need scrollbar
                            // scrollbar: {
                                //     el: '.swiper-scrollbar',
                                // },
                        });
                    }
                });
            } else {
                productList.innerHTML = '<div class="text-center col-span-full"><p class="text-gray-500">No products found.</p></div>';
            }
        }
    </script>
</body>
</html>
