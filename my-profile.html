<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Profile - Car Part Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .input-field {
      margin-bottom: 10px;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .button {
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .button:disabled {
      background-color: #888;
    }
  </style>
</head>
<body>

<h2>My Profile</h2>

<div id="user-profile" class="section">
  <!-- Profile information will be loaded here -->
  <p id="loading">Loading profile...</p>
</div>

<div id="edit-profile" class="section" style="display: none;">
  <h3>Edit Profile</h3>
  <form id="edit-form">
    <div>
      <label for="name">Name</label>
      <input type="text" id="name" class="input-field">
    </div>
    <div>
      <label for="email">Email</label>
      <input type="email" id="email" class="input-field">
    </div>
    <div>
      <label for="phone">Phone</label>
      <input type="text" id="phone" class="input-field">
    </div>
    <div>
      <label for="address">Address</label>
      <input type="text" id="address" class="input-field">
    </div>
    <div>
      <label for="pinCode">Pin Code</label>
      <input type="text" id="pinCode" class="input-field">
    </div>
    <button type="submit" class="button">Save Changes</button>
  </form>
</div>

<div>
  <button id="edit-button" class="button">Edit Profile</button>
  <button id="cancel-button" class="button" style="display: none;">Cancel</button>
</div>

<script>
// Get userId from localStorage
// Get user data from localStorage
const userData = JSON.parse(localStorage.getItem('user'));
const userId = userData?.user?.userId;
const token = userData?.token; // Assuming token is stored here

const userProfileDiv = document.getElementById('user-profile');
const editProfileDiv = document.getElementById('edit-profile');
const loadingDiv = document.getElementById('loading');
const editButton = document.getElementById('edit-button');
const cancelButton = document.getElementById('cancel-button');

if (!userId) {
  userProfileDiv.innerHTML = "<p class='text-red-500'>User not found. Please log in.</p>";
}

// Fetch user data with authentication
async function fetchUserProfile() {
  try {
    const response = await fetch(`http://localhost:8080/api/users/${userId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`, // Add the token in the Authorization header
      },
    });

    const user = await response.json();
    
    if (response.ok) {
      userProfileDiv.innerHTML = `
        <h3>Profile Information</h3>
        <p><strong>Name:</strong> ${user.name}</p>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Phone:</strong> ${user.phone}</p>
        <p><strong>Address:</strong> ${user.address}</p>
        <p><strong>Pin Code:</strong> ${user.pinCode}</p>
      `;
    } else {
      userProfileDiv.innerHTML = `<p class='text-red-500'>Failed to load profile.</p>`;
    }
  } catch (error) {
    console.error('Error fetching user profile:', error);
    userProfileDiv.innerHTML = `<p class='text-red-500'>Error fetching profile.</p>`;
  }
}

// Display the edit form
function showEditForm() {
  editProfileDiv.style.display = 'block';
  editButton.style.display = 'none';
  cancelButton.style.display = 'inline-block';
  
  // Prefill the edit form with user data
  document.getElementById('name').value = userData.user.name;
  document.getElementById('email').value = userData.user.email;
  document.getElementById('phone').value = userData.user.phone;
  document.getElementById('address').value = userData.user.address;
  document.getElementById('pinCode').value = userData.user.pinCode;
}

// Hide the edit form
function hideEditForm() {
  editProfileDiv.style.display = 'none';
  editButton.style.display = 'inline-block';
  cancelButton.style.display = 'none';
}

// Handle profile edit submission
async function handleEditForm(event) {
  event.preventDefault();
  
  const updatedUser = {
    name: document.getElementById('name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    address: document.getElementById('address').value,
    pinCode: document.getElementById('pinCode').value,
  };
  
  try {
    const response = await fetch(`http://localhost:8080/api/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`, // Add token in Authorization header
      },
      body: JSON.stringify(updatedUser),
    });

    const updatedUserData = await response.json();
    
    if (response.ok) {
      // Update the localStorage data and reload profile
      userData.user = updatedUserData;
      localStorage.setItem('user', JSON.stringify(userData));
      
      // Reload profile
      fetchUserProfile();
      
      hideEditForm();
    } else {
      alert('Failed to update profile.');
    }
  } catch (error) {
    console.error('Error updating user profile:', error);
    alert('Error updating profile.');
  }
}

// Event Listeners
editButton.addEventListener('click', showEditForm);
cancelButton.addEventListener('click', hideEditForm);
document.getElementById('edit-form').addEventListener('submit', handleEditForm);

// Fetch user profile when the page loads
fetchUserProfile();

</script>

</body>
</html>
