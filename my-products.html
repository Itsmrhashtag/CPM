<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Products - CarPartMarketplace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .product-card {
            @apply bg-white rounded-lg shadow-md p-4 transition-transform transform hover:scale-105;
        }
        .product-card-title {
            @apply text-xl font-semibold text-gray-800 mb-2;
        }
        .product-card-description {
            @apply text-gray-700 mb-2;
        }
        .product-card-price {
            @apply text-gray-900 font-bold text-lg mb-2;
        }
        .product-card-image {
            @apply rounded-md mb-4 w-full h-48 object-cover;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded;
        }
        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        /* Swiper Styles */
        .swiper {
            width: 100%;
            height: 300px;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .swiper-slide {
            text-align: center;
            font-size: 18px;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .swiper-pagination-bullet-active {
            background-color: #3b82f6; /* Tailwind's blue-500 */
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-gray-800 text-white py-4">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl font-semibold">My Products</h1>
        </div>
    </header>
    <main class="container mx-auto px-4 py-8">
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-2xl font-semibold">Your Products</h2>
            <button onclick="toggleForm()" class="btn-primary">+ Add Product</button>
        </div>
        
        <!-- Product Form -->
        <div id="product-form" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <h3 class="text-xl font-semibold mb-4">Add New Product</h3>
            <form id="add-product-form" enctype="multipart/form-data">
                <div class="mb-4">
                    <label class="block font-medium mb-1">Title</label>
                    <input type="text" name="title" class="w-full border px-3 py-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Description</label>
                    <textarea name="description" class="w-full border px-3 py-2 rounded" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Price</label>
                    <input type="number" name="price" class="w-full border px-3 py-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Category</label>
                    <input type="text" name="category" class="w-full border px-3 py-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Upload Images</label>
                    <input type="file" name="images" multiple class="w-full border px-3 py-2 rounded">
                </div>
                <button type="submit" class="btn-primary">Submit</button>
            </form>
            
        </div>
        <div id="update-form" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <h3 class="text-xl font-semibold mb-4">Update Product</h3>
            <form id="update-product-form" enctype="multipart/form-data">
                <input type="hidden" name="productId">
                <div class="mb-4">
                    <label class="block font-medium mb-1">Title</label>
                    <input type="text" name="title" class="w-full border px-3 py-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Description</label>
                    <textarea name="description" class="w-full border px-3 py-2 rounded" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Price</label>
                    <input type="number" name="price" class="w-full border px-3 py-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Category</label>
                    <input type="text" name="category" class="w-full border px-3 py-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block font-medium mb-1">Replace Images (optional)</label>
                    <input type="file" name="images" multiple class="w-full border px-3 py-2 rounded">
                </div>
                <button type="submit" class="btn-primary bg-yellow-500 hover:bg-yellow-600">Update Product</button>
            </form>
        </div>
        
        
        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-center">
                <p class="text-gray-500">Loading products...</p>
            </div>
        </div>
    </main>
    <script>
        function toggleForm() {
        const form = document.getElementById('product-form');
        form.classList.toggle('hidden');
    }

    const addForm = document.getElementById('add-product-form');
    addForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || !user.token) {
            return alert("Please login to add a product.");
        }

        const formData = new FormData(addForm);

        try {
            const res = await fetch("http://localhost:8080/api/products/add", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${user.token}`
                },
                body: formData
            });

            const text = await res.text();
            alert(text);

            // Refresh the product list
            location.reload();
        } catch (err) {
            console.error(err);
            alert("Error adding product");
        }
    });
    function showUpdateForm(productId) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user.token) {
        alert("Please login to update a product.");
        return;
    }

    fetch(`http://localhost:8080/api/products/${productId}`, {
        method: "GET",
        headers: {
            "Authorization": `Bearer ${user.token}`
        }
    })
    .then(res => res.json())
    .then(product => {
        const form = document.getElementById('update-product-form');
        form.productId.value = product.id;
        form.title.value = product.title;
        form.description.value = product.description;
        form.price.value = product.price;
        form.category.value = product.category;

        document.getElementById('update-form').classList.remove('hidden');
        window.scrollTo(0, document.getElementById('update-form').offsetTop);
    })
    .catch(err => {
        console.error("Error fetching product for update:", err);
        alert("Failed to fetch product details.");
    });
}

document.getElementById('update-product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const productId = form.productId.value;
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user.token) {
        alert("Login required");
        return;
    }

    const formData = new FormData(form);

    try {
        const res = await fetch(`http://localhost:8080/api/products/update/${productId}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${user.token}`
            },
            body: formData
        });

        if (!res.ok) throw new Error(await res.text());

        alert("Product updated successfully");
        location.reload();
    } catch (err) {
        console.error(err);
        alert("Error updating product");
    }
});

        const myHeaders = new Headers();
        const user = localStorage.getItem('user');
        if (user) {
            const authToken = JSON.parse(user).token;
            myHeaders.append("Authorization", `Bearer ${authToken}`);
        } else {
            window.location.href = '/login.html';
        }

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch("http://localhost:8080/api/products/my", requestOptions)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Failed to fetch products');
                    });
                }
                return response.json();
            })
            .then(result => {
                const productList = document.getElementById('product-list');
                productList.innerHTML = '';
                if (result && result.length > 0) {
                    result.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';

                        let imageContent = '';
                        if (product.imageNames && product.imageNames.length > 1) {
                            // Create carousel for multiple images
                            imageContent = `<div class="swiper">
                                            <div class="swiper-wrapper">`;
                            product.imageNames.forEach(imageName => {
                                imageContent += `<div class="swiper-slide">
                                                    <img src="http://localhost:8080/uploads/${imageName}" alt="${product.name}" class="product-card-image">
                                                </div>`;
                            });
                            imageContent += `</div>
                                            <div class="swiper-pagination"></div>
                                        </div>`;
                        } else if (product.imageNames && product.imageNames.length === 1) {
                            // Display single image
                            imageContent = `<img src="http://localhost:8080/uploads/${product.imageNames[0]}" alt="${product.name}" class="product-card-image">`;
                        } else {
                            // Display placeholder
                            imageContent = `<img src="https://via.placeholder.com/150" alt="${product.name}" class="product-card-image">`;
                        }

                        productCard.innerHTML = `
                            ${imageContent}
                            <h2 class="product-card-title">${product.title}</h2>
                            <p class="product-card-description">${product.description}</p>
                            <p class="product-card-price">Price: $${product.price}</p>
                            <a href="/product-detail.html?id=${product.id}" class="btn-primary">View Details</a>
                            <div class="flex gap-2 mt-3">
  <button onclick="deleteProduct(${product.id})" class="btn-primary bg-red-500 hover:bg-red-700">Delete</button>
  <button onclick="showUpdateForm(${product.id})" class="btn-primary bg-yellow-500 hover:bg-yellow-600">Update</button>
</div>

                        `;
                        productList.appendChild(productCard);

                         if (product.imageNames && product.imageNames.length > 1) {
                            // Initialize Swiper carousel
                            const swiper = new Swiper(productCard.querySelector('.swiper'), {
                                // Optional parameters
                                direction: 'horizontal',
                                loop: true,
                                // If we need pagination
                                // pagination: {
                                //     el: '.swiper-pagination',
                                // },
                                // Navigation arrows
                                // navigation: {
                                //     nextEl: '.swiper-button-next',
                                //     prevEl: '.swiper-button-prev',
                                // },
                                // And if we need scrollbar
                                scrollbar: {
                                    el: '.swiper-scrollbar',
                                },
                            });
                        }
                    });
                } else {
                    productList.innerHTML = '<div class="text-center col-span-full"><p class="text-gray-500">No products found.</p></div>';
                }
            })
            .catch(error => {
                const productList = document.getElementById('product-list');
                productList.innerHTML = `<div class="text-center col-span-full text-red-500">${error.message}</div>`;
                console.error(error);
            });
            function deleteProduct(productId) {
  if (!confirm("Are you sure you want to delete this product?")) return;

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.token) {
    alert("You must be logged in to delete a product.");
    return;
  }

  fetch(`http://localhost:8080/api/products/delete/${productId}`, {
    method: "DELETE",
    headers: {
      "Authorization": `Bearer ${user.token}`
    }
  })
    .then(res => {
      if (!res.ok) throw new Error("Failed to delete product");
      alert("Product deleted successfully");
      location.reload();
    })
    .catch(err => {
      alert("Error deleting product");
      console.error(err);
    });
}


    </script>
</body>
</html>
