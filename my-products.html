<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Products - CarPartMarketplace</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css"/>
  <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-700 to-blue-500 text-white shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-5">
      <h1 class="text-3xl font-bold text-center">ðŸš— My Products</h1>
    </div>
  </header>

  <!-- Main Section -->
  <main class="max-w-7xl mx-auto px-6 py-10">
    <!-- Add Product Button and Form -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Your Products</h2>
        <button onclick="toggleForm('add')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-md shadow-md transition duration-200">
          + Add Product
        </button>
      </div>

      <!-- Add Product Form -->
      <div id="add-product-form-container" class="hidden bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Add New Product</h3>
        <form id="add-product-form" enctype="multipart/form-data">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block font-medium text-gray-700 mb-1">Title</label>
              <input type="text" name="title" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required />
            </div>
            <div>
              <label class="block font-medium text-gray-700 mb-1">Category</label>
              <input type="text" name="category" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required />
            </div>
            <div>
              <label class="block font-medium text-gray-700 mb-1">Price</label>
              <input type="number" name="price" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required />
            </div>
            <div class="md:col-span-2">
              <label class="block font-medium text-gray-700 mb-1">Description</label>
              <textarea name="description" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block font-medium text-gray-700 mb-1">Upload Images</label>
              <input type="file" name="images" multiple class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" accept="image/*" />
            </div>
          </div>
          <div class="flex space-x-4 mt-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-md shadow-md transition duration-200">
              Submit
            </button>
            <button type="button" onclick="toggleForm('add')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded-md shadow-md transition duration-200">
              Cancel
            </button>
          </div>
        </form>
      </div>

      <!-- Edit Product Form -->
      <div id="edit-product-form-container" class="hidden bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Edit Product</h3>
        <form id="edit-product-form" enctype="multipart/form-data">
          <input type="hidden" name="id" />
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block font-medium text-gray-700 mb-1">Title</label>
              <input type="text" name="title" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required />
            </div>
            <div>
              <label class="block font-medium text-gray-700 mb-1">Category</label>
              <input type="text" name="category" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required />
            </div>
            <div>
              <label class="block font-medium text-gray-700 mb-1">Price</label>
              <input type="number" name="price" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required />
            </div>
            <div class="md:col-span-2">
              <label class="block font-medium text-gray-700 mb-1">Description</label>
              <textarea name="description" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" required></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block font-medium text-gray-700 mb-1">Upload New Images (Optional)</label>
              <input type="file" name="images" multiple class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" accept="image/*" />
            </div>
          </div>
          <div class="flex space-x-4 mt-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-md shadow-md transition duration-200">
              Save Changes
            </button>
            <button type="button" onclick="toggleForm('edit')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded-md shadow-md transition duration-200">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Product Grid -->
    <div id="product-list" class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
      <div class="text-center col-span-full">
        <p class="text-gray-500 text-lg">Loading products...</p>
      </div>
    </div>
  </main>

  <!-- JS Section -->
  <script>
    function toggleForm(mode) {
      const addFormContainer = document.getElementById('add-product-form-container');
      const editFormContainer = document.getElementById('edit-product-form-container');
      if (mode === 'add') {
        addFormContainer.classList.toggle('hidden');
        editFormContainer.classList.add('hidden');
      } else if (mode === 'edit') {
        editFormContainer.classList.toggle('hidden');
        addFormContainer.classList.add('hidden');
      }
    }

    // Add Product
    const addForm = document.getElementById('add-product-form');
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const user = JSON.parse(localStorage.getItem('user'));
      if (!user || !user.token) {
        Swal.fire({
          icon: 'error',
          title: 'Not Authenticated',
          text: 'Please log in to add a product.',
        }).then(() => {
          window.location.href = '/login.html';
        });
        return;
      }

      const formData = new FormData(addForm);

      try {
        const res = await fetch("http://localhost:8080/api/products/add", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${user.token}`
          },
          body: formData
        });

        const text = await res.text();
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: text,
          }).then(() => {
            location.reload();
          });
        } else {
          throw new Error(text || 'Failed to add product');
        }
      } catch (err) {
        console.error('Error adding product:', err);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: err.message || 'Error adding product',
        });
      }
    });

    // Edit Product
    function openEditForm(product) {
      const editForm = document.getElementById('edit-product-form');
      editForm.querySelector('input[name="id"]').value = product.id;
      editForm.querySelector('input[name="title"]').value = product.title;
      editForm.querySelector('input[name="category"]').value = product.category;
      editForm.querySelector('input[name="price"]').value = product.price;
      editForm.querySelector('textarea[name="description"]').value = product.description;
      toggleForm('edit');
    }

    const editForm = document.getElementById('edit-product-form');
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const user = JSON.parse(localStorage.getItem('user'));
      if (!user || !user.token) {
        Swal.fire({
          icon: 'error',
          title: 'Not Authenticated',
          text: 'Please log in to edit a product.',
        }).then(() => {
          window.location.href = '/login.html';
        });
        return;
      }

      const formData = new FormData(editForm);
      const productId = formData.get('id');

      try {
        const res = await fetch(`http://localhost:8080/api/products/update/${productId}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${user.token}`
          },
          body: formData
        });

        const text = await res.text();
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: text,
          }).then(() => {
            location.reload();
          });
        } else {
          throw new Error(text || 'Failed to update product');
        }
      } catch (err) {
        console.error('Error updating product:', err);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: err.message || 'Error updating product',
        });
      }
    });

    // Delete Product
    async function deleteProduct(productId) {
      const user = JSON.parse(localStorage.getItem('user'));
      if (!user || !user.token) {
        Swal.fire({
          icon: 'error',
          title: 'Not Authenticated',
          text: 'Please log in to delete a product.',
        }).then(() => {
          window.location.href = '/login.html';
        });
        return;
      }

      const confirmation = await Swal.fire({
        icon: 'warning',
        title: 'Are you sure?',
        text: 'This will permanently delete the product.',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
      });

      if (!confirmation.isConfirmed) return;

      try {
        const res = await fetch(`http://localhost:8080/api/products/delete/${productId}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${user.token}`
          }
        });

        const text = await res.text();
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: text,
          }).then(() => {
            location.reload();
          });
        } else {
          throw new Error(text || 'Failed to delete product');
        }
      } catch (err) {
        console.error('Error deleting product:', err);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: err.message || 'Error deleting product',
        });
      }
    }

    // Fetch Products
    const myHeaders = new Headers();
    const user = localStorage.getItem('user');
    if (!user) {
      Swal.fire({
        icon: 'error',
        title: 'Not Authenticated',
        text: 'Please log in to view your products.',
      }).then(() => {
        window.location.href = '/login.html';
      });
    } else {
      const authToken = JSON.parse(user).token;
      myHeaders.append("Authorization", `Bearer ${authToken}`);

      const requestOptions = {
        method: "GET",
        headers: myHeaders,
        redirect: "follow"
      };

      fetch("http://localhost:8080/api/products/my", requestOptions)
        .then(response => {
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error(text || 'Failed to fetch products');
            });
          }
          return response.json();
        })
        .then(result => {
          const productList = document.getElementById('product-list');
          productList.innerHTML = '';
          if (result && result.length > 0) {
            result.forEach(product => {
              const productCard = document.createElement('div');
              productCard.className = 'bg-white rounded-xl shadow-lg p-5 transition-transform hover:-translate-y-1 hover:shadow-xl duration-300';

              let imageContent = '';
              const uniqueId = `swiper-${product.id}`;

              if (product.imageNames?.length > 1) {
                imageContent = `<div class="swiper ${uniqueId} rounded-md mb-4 h-48 overflow-hidden">
                  <div class="swiper-wrapper">
                    ${product.imageNames.map(image =>
                      `<div class="swiper-slide"><img src="http://localhost:8080/uploads/${image}" class="w-full h-48 object-cover" /></div>`
                    ).join('')}
                  </div>
                  <div class="swiper-pagination"></div>
                </div>`;
              } else if (product.imageNames?.length === 1) {
                imageContent = `<img src="http://localhost:8080/uploads/${product.imageNames[0]}" alt="${product.title}" class="rounded-md mb-4 w-full h-48 object-cover" />`;
              } else {
                imageContent = `<img src="https://via.placeholder.com/300x200?text=No+Image" class="rounded-md mb-4 w-full h-48 object-cover" />`;
              }

              productCard.innerHTML = `
                ${imageContent}
                <h2 class="text-xl font-semibold text-gray-800 mb-2">${product.title}</h2>
                <span class="inline-block bg-blue-100 text-blue-700 text-xs font-medium px-2 py-1 rounded-full w-max mb-2">${product.category}</span>
                <p class="text-gray-600 mb-2">${product.description}</p>
                <p class="text-blue-700 font-bold text-lg mb-4">ðŸ’²${product.price}</p>
                <div class="flex space-x-2">
                  <button onclick='openEditForm(${JSON.stringify(product)})' class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition">Edit</button>
                  <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">Delete</button>
                </div>
              `;
              productList.appendChild(productCard);

              if (product.imageNames?.length > 1) {
                new Swiper(`.${uniqueId}`, {
                  direction: 'horizontal',
                  loop: true,
                  pagination: {
                    el: `.${uniqueId} .swiper-pagination`,
                    clickable: true,
                  }
                });
              }
            });
          } else {
            productList.innerHTML = '<div class="text-center col-span-full"><p class="text-gray-500">You have no products listed.</p></div>';
          }
        })
        .catch(error => {
          console.error('Error fetching products:', error);
          const productList = document.getElementById('product-list');
          productList.innerHTML = `<div class="text-center col-span-full text-red-500">${error.message}</div>`;
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: error.message || 'Failed to load products',
          });
        });
    }
  </script>
</body>
</html>